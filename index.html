/*************************************************************
 * SISTEMA DE INSCRI√á√ÉO, CONFIRMA√á√ÉO E CERTIFICADOS AUTOM√ÅTICOS ‚Äì CTB
 * Autor: Paulo Santos (Clube dos Tenistas da Bahia)
 * Data: 2025-11-01
 * Integra√ß√£o: Google Sheets + Docs + Drive + Gmail
 *************************************************************/

function doPost(e) {
  try {
    // ID da planilha "Cadastro Oficina"
    const planilhaId = "COLOQUE_AQUI_O_ID_DA_SUA_PLANILHA";
    const aba = "Respostas";

    const ss = SpreadsheetApp.openById(planilhaId);
    const sheet = ss.getSheetByName(aba);
    const dados = e.parameter;

    // Adiciona os dados na planilha
    const dataAtual = new Date();
    sheet.appendRow([
      dataAtual,
      dados.nome,
      dados.entidade,
      dados.funcao,
      dados.whatsapp,
      dados.email,
      "Inscri√ß√£o Recebida"
    ]);

    // Monta corpo do e-mail
    const assunto = "‚úÖ Confirma√ß√£o de Inscri√ß√£o ‚Äì Oficina CTB com Prof. Nelson Machado";
    const textoQRCode = `üèì Oficina CTB - Confirma√ß√£o de Inscri√ß√£o
üë§ ${dados.nome}
üè´ ${dados.entidade}
üéØ ${dados.funcao}
üìû ${dados.whatsapp}
üìß ${dados.email}`;
    const qrUrl = "https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=" + encodeURIComponent(textoQRCode);

    const corpo = `
      <div style="font-family:Arial,sans-serif; color:#002855;">
        <h2>üèì Confirma√ß√£o de Inscri√ß√£o</h2>
        <p>Ol√°, <strong>${dados.nome}</strong>!</p>
        <p>Sua inscri√ß√£o na <strong>Oficina de T√™nis de Mesa com o Prof. Nelson Machado</strong> foi registrada com sucesso.</p>
        <p><b>Entidade:</b> ${dados.entidade}<br/>
        <b>Fun√ß√£o:</b> ${dados.funcao}<br/>
        <b>WhatsApp:</b> ${dados.whatsapp}<br/>
        <b>E-mail:</b> ${dados.email}</p>
        <p>üìç Local: CTB Thales de Azevedo ‚Äì Salvador, Bahia</p>
        <p>üóìÔ∏è Data: 20 a 22 de novembro de 2025</p>
        <center><img src="${qrUrl}" alt="QR Code de Confirma√ß√£o"></center>
        <br/>
        <p>Atenciosamente,<br/>
        <b>Clube dos Tenistas da Bahia - CTB</b><br/>
        üìß paulo@ctb-ba.com.br</p>
      </div>
    `;

    // Envia e-mail de confirma√ß√£o
    GmailApp.sendEmail(dados.email, assunto, "", { htmlBody: corpo });

    // Retorna OK para o site
    return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.TEXT);

  } catch (erro) {
    return ContentService.createTextOutput("ERRO: " + erro.message).setMimeType(ContentService.MimeType.TEXT);
  }
}


/*************************************************************
 * GERA√á√ÉO AUTOM√ÅTICA DE CERTIFICADOS
 *************************************************************/
function gerarCertificados() {
  const senha = "ctb2025"; // senha de administrador
  const planilhaId = "COLOQUE_AQUI_O_ID_DA_SUA_PLANILHA";
  const docModeloId = "COLOQUE_AQUI_O_ID_DO_MODELO_DO_CERTIFICADO";
  const pastaCertificadosId = "COLOQUE_AQUI_O_ID_DA_PASTA_PARA_SALVAR_PDFS";

  const planilha = SpreadsheetApp.openById(planilhaId);
  const sheet = planilha.getSheetByName("Respostas");
  const dados = sheet.getDataRange().getValues();

  const modelo = DriveApp.getFileById(docModeloId);
  const pasta = DriveApp.getFolderById(pastaCertificadosId);

  for (let i = 1; i < dados.length; i++) {
    const linha = dados[i];
    const nome = linha[1];
    const entidade = linha[2];
    const funcao = linha[3];
    const email = linha[5];
    const status = linha[6];

    if (status !== "Certificado Enviado") {
      const copia = modelo.makeCopy(`Certificado - ${nome}`, pasta);
      const doc = DocumentApp.openById(copia.getId());
      const corpo = doc.getBody();

      corpo.replaceText("{{NOME}}", nome);
      corpo.replaceText("{{FUNCAO}}", funcao);
      corpo.replaceText("{{ENTIDADE}}", entidade);
      corpo.replaceText("{{TITULO_EVENTO}}", "Oficina de T√™nis de Mesa ‚Äì Forma√ß√£o T√©cnica");
      corpo.replaceText("{{DATA_EVENTO}}", "20 a 22 de novembro de 2025");
      corpo.replaceText("{{LOCAL}}", "CTB Thales de Azevedo ‚Äì Salvador/BA");
      corpo.replaceText("{{ASSINATURA}}", "Prof. Nelson Machado");
      doc.saveAndClose();

      const pdf = copia.getAs("application/pdf");
      GmailApp.sendEmail(email, "üìú Certificado - Oficina CTB", "Segue seu certificado em anexo.", {
        attachments: [pdf]
      });

      sheet.getRange(i + 1, 7).setValue("Certificado Enviado");
    }
  }
  return ContentService.createTextOutput("Certificados enviados com sucesso.").setMimeType(ContentService.MimeType.TEXT);
}
