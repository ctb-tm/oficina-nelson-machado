/*************************************************************
 * SISTEMA DE INSCRIÇÃO, CONFIRMAÇÃO E CERTIFICADOS AUTOMÁTICOS – CTB
 * Autor: Paulo Santos (Clube dos Tenistas da Bahia)
 * Data: 2025-11-01
 * Integração: Google Sheets + Docs + Drive + Gmail
 *************************************************************/

function doPost(e) {
  try {
    const planilhaNome = "Cadastro Oficina";
    const abaNome = "Respostas";
    const emailOrganizador = "pfeira2025@gmail.com";

    const ss = SpreadsheetApp.openByName(planilhaNome);
    const sheet = ss.getSheetByName(abaNome);
    const data = e.parameter;
    const timestamp = new Date();

    const novaLinha = [
      timestamp,
      data.nome,
      data.entidade,
      data.funcao,
      data.whatsapp,
      data.email,
      "Confirmado"
    ];
    sheet.appendRow(novaLinha);

    const qrTexto = `
🏓 Oficina CTB - Confirmação de Inscrição
👤 ${data.nome}
🏫 ${data.entidade}
🎯 ${data.funcao}
📞 ${data.whatsapp}
📧 ${data.email}
    `;
    const qrUrl = "https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=" + encodeURIComponent(qrTexto);

    const assuntoParticipante = "Confirmação de Inscrição - Oficina CTB com Prof. Nelson Machado";
    const corpoEmailParticipante = `
      <div style="font-family:Arial,sans-serif;color:#002855;">
        <h2>🏓 Confirmação de Inscrição</h2>
        <p>Olá, <strong>${data.nome}</strong>!</p>
        <p>Sua inscrição na <strong>Oficina de Tênis de Mesa com o Prof. Nelson Machado</strong> foi registrada com sucesso.</p>
        <p>Apresente este QR Code no credenciamento:</p>
        <center><img src="${qrUrl}" alt="QR Code de Confirmação" /></center>
        <p>📍 CTB Thales de Azevedo – Salvador/BA<br>🗓️ 20 a 22 de novembro de 2025</p>
        <p>Atenciosamente,<br><b>Equipe CTB</b><br>📧 paulo@ctb-ba.com.br</p>
      </div>
    `;
    MailApp.sendEmail({
      to: data.email,
      subject: assuntoParticipante,
      htmlBody: corpoEmailParticipante,
      name: "CTB - Oficina de Tênis de Mesa"
    });

    const assuntoOrganizador = `📥 Nova inscrição confirmada: ${data.nome}`;
    const corpoEmailOrganizador = `
      <b>Nova inscrição confirmada!</b><br><br>
      <b>Nome:</b> ${data.nome}<br>
      <b>Entidade:</b> ${data.entidade}<br>
      <b>Função:</b> ${data.funcao}<br>
      <b>WhatsApp:</b> ${data.whatsapp}<br>
      <b>E-mail:</b> ${data.email}<br>
      <b>Data:</b> ${timestamp.toLocaleString("pt-BR")}
    `;
    MailApp.sendEmail({
      to: emailOrganizador,
      subject: assuntoOrganizador,
      htmlBody: corpoEmailOrganizador
    });

    return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.TEXT);

  } catch (err) {
    return ContentService.createTextOutput("ERRO: " + err.message)
      .setMimeType(ContentService.MimeType.TEXT);
  }
}

/*************************************************************
 * FUNÇÃO AUTOMÁTICA: GERA E ENVIA CERTIFICADOS PERSONALIZADOS
 *************************************************************/
function gerarCertificados() {
  const planilhaNome = "Cadastro Oficina";
  const abaNome = "Respostas";
  const ss = SpreadsheetApp.openByName(planilhaNome);
  const sheet = ss.getSheetByName(abaNome);
  const dados = sheet.getDataRange().getValues();

  const pastaNome = "Certificados Oficina CTB";
  const pastaDrive = obterOuCriarPasta(pastaNome);
  const modeloNome = "Modelo Certificado CTB"; // nome do Google Docs modelo

  const modelo = DriveApp.getFilesByName(modeloNome).next();
  const arquivoModelo = DocumentApp.openById(modelo.getId());

  for (let i = 1; i < dados.length; i++) {
    const nome = dados[i][1];
    const entidade = dados[i][2];
    const funcao = dados[i][3];
    const email = dados[i][5];
    const status = dados[i][6];

    if (status === "Confirmado" && nome && email) {
      const copia = modelo.makeCopy(`Certificado - ${nome}`, pastaDrive);
      const doc = DocumentApp.openById(copia.getId());
      const corpo = doc.getBody();

      // Substituir marcadores no modelo
      corpo.replaceText("{{NOME}}", nome);
      corpo.replaceText("{{FUNCAO}}", funcao);
      corpo.replaceText("{{ENTIDADE}}", entidade);
      corpo.replaceText("{{DATA_EVENTO}}", "20 a 22 de novembro de 2025");
      corpo.replaceText("{{LOCAL}}", "CTB Thales de Azevedo – Salvador/BA");
      corpo.replaceText("{{ASSINATURA}}", "Prof. Nelson Machado");
      corpo.replaceText("{{TITULO_EVENTO}}", "Oficina de Tênis de Mesa - Formação e Metodologia Técnica");

      doc.saveAndClose();

      const blob = doc.getAs("application/pdf").setName(`Certificado - ${nome}.pdf`);
      const pdfFile = pastaDrive.createFile(blob);

      const assunto = "🏆 Certificado - Oficina de Tênis de Mesa CTB";
      const corpoEmail = `
        <div style="font-family:Arial,sans-serif;color:#002855;">
          <h2>🏆 Certificado de Participação</h2>
          <p>Olá, <strong>${nome}</strong>!</p>
          <p>Seu certificado de participação na <b>Oficina de Tênis de Mesa – Prof. Nelson Machado</b> está anexado.</p>
          <p>📍 <b>Local:</b> CTB Thales de Azevedo – Salvador/BA<br>🗓️ <b>Data:</b> 20 a 22 de novembro de 2025</p>
          <p>Parabéns pela participação!</p>
          <p><b>Equipe CTB</b></p>
        </div>
      `;
      MailApp.sendEmail({
        to: email,
        subject: assunto,
        htmlBody: corpoEmail,
        attachments: [pdfFile.getAs(MimeType.PDF)]
      });

      // Atualiza status na planilha
      sheet.getRange(i + 1, 7).setValue("Certificado Enviado");
    }
  }
}

/*************************************************************
 * Função utilitária: cria ou encontra uma pasta no Google Drive
 *************************************************************/
function obterOuCriarPasta(nome) {
  const pastas = DriveApp.getFoldersByName(nome);
  return pastas.hasNext() ? pastas.next() : DriveApp.createFolder(nome);
}
